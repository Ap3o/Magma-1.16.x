--- a/net/minecraft/entity/player/ServerPlayerEntity.java
+++ b/net/minecraft/entity/player/ServerPlayerEntity.java
@@ -6,6 +6,7 @@
 import java.util.Collection;
 import java.util.Iterator;
 import java.util.List;
+import java.util.Optional;
 import java.util.OptionalInt;
 import java.util.Random;
 import java.util.UUID;
@@ -13,11 +14,15 @@
 import net.minecraft.advancements.CriteriaTriggers;
 import net.minecraft.advancements.PlayerAdvancements;
 import net.minecraft.block.BlockState;
+import net.minecraft.block.ChestBlock.DoubleInventory;
 import net.minecraft.block.HorizontalBlock;
+import net.minecraft.block.pattern.BlockPattern.PortalInfo;
+import net.minecraft.command.CommandSource;
 import net.minecraft.command.arguments.EntityAnchorArgument;
 import net.minecraft.crash.CrashReport;
 import net.minecraft.crash.CrashReportCategory;
 import net.minecraft.crash.ReportedException;
+import net.minecraft.enchantment.EnchantmentHelper;
 import net.minecraft.entity.Entity;
 import net.minecraft.entity.IAngerable;
 import net.minecraft.entity.LivingEntity;
@@ -80,6 +85,7 @@
 import net.minecraft.scoreboard.Score;
 import net.minecraft.scoreboard.ScoreCriteria;
 import net.minecraft.scoreboard.ScorePlayerTeam;
+import net.minecraft.scoreboard.Scoreboard;
 import net.minecraft.scoreboard.Team;
 import net.minecraft.server.MinecraftServer;
 import net.minecraft.server.management.PlayerInteractionManager;
@@ -90,10 +96,12 @@
 import net.minecraft.tileentity.CommandBlockTileEntity;
 import net.minecraft.tileentity.SignTileEntity;
 import net.minecraft.tileentity.TileEntity;
+import net.minecraft.util.CombatTracker;
 import net.minecraft.util.CooldownTracker;
 import net.minecraft.util.DamageSource;
 import net.minecraft.util.Direction;
 import net.minecraft.util.EntityDamageSource;
+import net.minecraft.util.FoodStats;
 import net.minecraft.util.Hand;
 import net.minecraft.util.HandSide;
 import net.minecraft.util.NonNullList;
@@ -122,12 +130,30 @@
 import net.minecraft.world.World;
 import net.minecraft.world.biome.BiomeManager;
 import net.minecraft.world.server.ServerWorld;
-import net.minecraft.world.storage.IWorldInfo;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import org.bukkit.Bukkit;
+import org.bukkit.GameMode;
+import org.bukkit.Location;
+import org.bukkit.WeatherType;
+import org.bukkit.command.CommandSender;
+import org.bukkit.craftbukkit.CraftWorld;
+import org.bukkit.craftbukkit.entity.CraftPlayer;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.craftbukkit.inventory.CraftItemStack;
+import org.bukkit.event.inventory.InventoryType;
+import org.bukkit.event.player.PlayerChangedMainHandEvent;
+import org.bukkit.event.player.PlayerChangedWorldEvent;
+import org.bukkit.event.player.PlayerGameModeChangeEvent;
+import org.bukkit.event.player.PlayerLocaleChangeEvent;
+import org.bukkit.event.player.PlayerPortalEvent;
+import org.bukkit.event.player.PlayerTeleportEvent;
+import org.bukkit.event.player.PlayerTeleportEvent.TeleportCause;
+import org.bukkit.inventory.MainHand;
 
 public class ServerPlayerEntity extends PlayerEntity implements IContainerListener {
    private static final Logger field_147102_bM = LogManager.getLogger();
+   public String language = "en_us"; // private->public CraftBukkit - lowercase
    public ServerPlayNetHandler field_71135_a;
    public final MinecraftServer field_71133_b;
    public final PlayerInteractionManager field_71134_c;
@@ -143,8 +169,8 @@
    private float field_71149_ch = -1.0E8F;
    private int field_71146_ci = -99999999;
    private boolean field_71147_cj = true;
-   private int field_71144_ck = -99999999;
-   private int field_147101_bU = 60;
+   public int field_71144_ck = -99999999; // private->public CraftBukkit
+   public int field_147101_bU = 60; // private->public CraftBukkit
    private ChatVisibility field_71143_cn;
    private boolean field_71140_co = true;
    private long field_143005_bX = Util.func_211177_b();
@@ -167,6 +193,20 @@
    public int field_71138_i;
    public boolean field_71136_j;
 
+   // CraftBukkit start
+   public String displayName;
+   public ITextComponent listName;
+   public org.bukkit.Location compassTarget;
+   public int newExp = 0;
+   public int newLevel = 0;
+   public int newTotalExp = 0;
+   public boolean keepLevel = false;
+   public double maxHealthCache;
+   public boolean joining = true;
+   public boolean sentListPacket = false;
+   public Integer clientViewDistance;
+   // CraftBukkit end
+
    public ServerPlayerEntity(MinecraftServer p_i45285_1_, ServerWorld p_i45285_2_, GameProfile p_i45285_3_, PlayerInteractionManager p_i45285_4_) {
       super(p_i45285_2_, p_i45285_2_.func_241135_u_(), p_i45285_3_);
       p_i45285_4_.field_73090_b = this;
@@ -176,8 +216,43 @@
       this.field_192042_bX = p_i45285_1_.func_184103_al().func_192054_h(this);
       this.field_70138_W = 1.0F;
       this.func_205734_a(p_i45285_2_);
+
+      // CraftBukkit start
+      this.displayName = this.func_146103_bH().getName();
+      this.canPickUpLoot = true;
+      this.maxHealthCache = this.func_110138_aP();
    }
 
+   // Yes, this doesn't match Vanilla, but it's the best we can do for now.
+   // If this is an issue, PRs are welcome
+   public final BlockPos getSpawnPoint(ServerWorld worldserver) {
+      BlockPos blockposition = worldserver.func_241135_u_();
+      if (worldserver.func_230315_m_().func_218272_d() && worldserver.field_241103_E_.func_76077_q() != GameType.ADVENTURE) {
+         int i = Math.max(0, this.field_71133_b.func_184108_a(worldserver));
+         int j = MathHelper.func_76128_c(worldserver.func_175723_af().func_177729_b((double) blockposition.func_177958_n(), (double) blockposition.func_177952_p()));
+         if (j < i) {
+            i = j;
+         }
+         if (j <= 1) {
+            i = 1;
+         }
+         int k = (i * 2 + 1) * (i * 2 + 1);
+         int l = this.func_205735_q(k);
+         int i1 = (new Random()).nextInt(k);
+         for (int j1 = 0; j1 < k; ++j1) {
+            int k1 = (i1 + l * j1) % k;
+            int l1 = k1 % (i * 2 + 1);
+            int i2 = k1 / (i * 2 + 1);
+            BlockPos blockposition1 = SpawnLocationHelper.func_241092_a_(worldserver, blockposition.func_177958_n() + l1 - i, blockposition.func_177952_p() + i2 - i, false);
+            if (blockposition1 != null) {
+               return blockposition1;
+            }
+         }
+      }
+      return blockposition;
+   }
+   // CraftBukkit end
+
    private void func_205734_a(ServerWorld p_205734_1_) {
       BlockPos blockpos = p_205734_1_.func_241135_u_();
       if (p_205734_1_.func_230315_m_().func_218272_d() && p_205734_1_.func_73046_m().func_240793_aU_().func_76077_q() != GameType.ADVENTURE) {
@@ -242,11 +317,20 @@
       if (p_70037_1_.func_150297_b("recipeBook", 10)) {
          this.field_192041_cq.func_192825_a(p_70037_1_.func_74775_l("recipeBook"), this.field_71133_b.func_199529_aN());
       }
+      this.getBukkitEntity().readExtraData(p_70037_1_); // CraftBukkit
 
       if (this.func_70608_bn()) {
          this.func_213366_dy();
       }
 
+      // CraftBukkit start
+      String spawnWorld = p_70037_1_.func_74779_i("SpawnWorld");
+      CraftWorld oldWorld = (CraftWorld) Bukkit.getWorld(spawnWorld);
+      if (oldWorld != null) {
+         this.field_241137_cq_ = oldWorld.getHandle().func_234923_W_();
+      }
+      // CraftBukkit end
+
       if (p_70037_1_.func_150297_b("SpawnX", 99) && p_70037_1_.func_150297_b("SpawnY", 99) && p_70037_1_.func_150297_b("SpawnZ", 99)) {
          this.field_241138_cr_ = new BlockPos(p_70037_1_.func_74762_e("SpawnX"), p_70037_1_.func_74762_e("SpawnY"), p_70037_1_.func_74762_e("SpawnZ"));
          this.field_241139_cs_ = p_70037_1_.func_74767_n("SpawnForced");
@@ -272,7 +356,20 @@
 
       Entity entity1 = this.func_184208_bv();
       Entity entity = this.func_184187_bx();
-      if (entity != null && entity1 != this && entity1.func_200601_bK()) {
+      // CraftBukkit start - handle non-persistent vehicles
+      boolean persistVehicle = true;
+      if (entity1 != null) {
+         Entity vehicle;
+         for (vehicle = entity1; vehicle != null; vehicle = vehicle.func_184187_bx()) {
+            if (!vehicle.persist) {
+               persistVehicle = false;
+               break;
+            }
+         }
+      }
+
+      if (persistVehicle && entity != null && entity1 != this && entity1.func_200601_bK()) {
+         // CraftBukkit end
          CompoundNBT compoundnbt1 = new CompoundNBT();
          CompoundNBT compoundnbt2 = new CompoundNBT();
          entity1.func_70039_c(compoundnbt2);
@@ -292,8 +389,31 @@
             p_213281_1_.func_218657_a("SpawnDimension", p_241148_1_);
          });
       }
+      this.getBukkitEntity().setExtraData(p_213281_1_);
+   }
 
+   // CraftBukkit start - World fallback code, either respawn location or global spawn
+   public void func_70029_a(World world) {
+      super.func_70029_a(world);
+      if (world == null) {
+         this.field_70729_aU = false;
+         Vector3d position = null;
+         if (this.field_241137_cq_ != null) {
+            world = this.func_71121_q().getServerCB().getHandle().func_72365_p().func_71218_a(this.field_241137_cq_);
+            if (world != null && this.func_241140_K_() != null) {
+               position = PlayerEntity.func_234567_a_((ServerWorld) world, this.func_241140_K_(), false, false).orElse(null);
+            }
+         }
+         if (world == null || position == null) {
+            world = ((CraftWorld) Bukkit.getServer().getWorlds().get(0)).getHandle();
+            position = Vector3d.func_237489_a_(((ServerWorld) world).func_241135_u_());
+         }
+         this.field_70170_p = world;
+         this.func_70107_b(position.func_82615_a(), position.func_82617_b(), position.func_82616_c());
+      }
+      this.field_71134_c.func_73080_a((ServerWorld) world);
    }
+   // CraftBukkit end
 
    public void func_195394_a(int p_195394_1_) {
       float f = (float)this.func_71050_bK();
@@ -340,6 +460,11 @@
    }
 
    public void func_70071_h_() {
+      // CraftBukkit start
+      if (this.joining) {
+         this.joining = false;
+      }
+      // CraftBukkit end
       this.field_71134_c.func_73075_a();
       --this.field_147101_bU;
       if (this.field_70172_ad > 0) {
@@ -404,7 +529,7 @@
          }
 
          if (this.func_110143_aJ() != this.field_71149_ch || this.field_71146_ci != this.field_71100_bB.func_75116_a() || this.field_71100_bB.func_75115_e() == 0.0F != this.field_71147_cj) {
-            this.field_71135_a.func_147359_a(new SUpdateHealthPacket(this.func_110143_aJ(), this.field_71100_bB.func_75116_a(), this.field_71100_bB.func_75115_e()));
+            this.field_71135_a.func_147359_a(new SUpdateHealthPacket(this.getBukkitEntity().getScaledHealth(), this.field_71100_bB.func_75116_a(), this.field_71100_bB.func_75115_e())); // CraftBukkit
             this.field_71149_ch = this.func_110143_aJ();
             this.field_71146_ci = this.field_71100_bB.func_75116_a();
             this.field_71147_cj = this.field_71100_bB.func_75115_e() == 0.0F;
@@ -435,6 +560,12 @@
             this.func_184849_a(ScoreCriteria.field_186701_k, MathHelper.func_76123_f((float)this.field_184856_bZ));
          }
 
+         // CraftBukkit start - Force max health updates
+         if (this.maxHealthCache != this.func_110138_aP()) {
+            this.getBukkitEntity().updateScaledHealth();
+         }
+         // CraftBukkit end
+
          if (this.field_71068_ca != this.field_184855_bY) {
             this.field_184855_bY = this.field_71068_ca;
             this.func_184849_a(ScoreCriteria.field_186702_l, MathHelper.func_76123_f((float)this.field_184855_bY));
@@ -449,6 +580,15 @@
             CriteriaTriggers.field_192135_o.func_192215_a(this);
          }
 
+         // CraftBukkit start - initialize oldLevel and fire PlayerLevelChangeEvent
+         if (this.oldLevel == -1) {
+            this.oldLevel = this.field_71068_ca;
+         }
+         if (this.oldLevel != this.field_71068_ca) {
+            CraftEventFactory.callPlayerLevelChangeEvent(this.field_70170_p.getServerCB().getPlayer((ServerPlayerEntity) this), this.oldLevel, this.field_71068_ca);
+            this.oldLevel = this.field_71068_ca;
+         }
+         // CraftBukkit end
       } catch (Throwable throwable) {
          CrashReport crashreport = CrashReport.func_85055_a(throwable, "Ticking player");
          CrashReportCategory crashreportcategory = crashreport.func_85058_a("Player being ticked");
@@ -458,15 +598,51 @@
    }
 
    private void func_184849_a(ScoreCriteria p_184849_1_, int p_184849_2_) {
-      this.func_96123_co().func_197893_a(p_184849_1_, this.func_195047_I_(), (p_195397_1_) -> {
-         p_195397_1_.func_96647_c(p_184849_2_);
+      // CraftBukkit - Use our scores instead
+      this.field_70170_p.getServerCB().getScoreboardManager().getScoreboardScores(p_184849_1_, this.func_146103_bH().getName(), (scoreboardscore) -> {
+         scoreboardscore.func_96647_c(p_184849_2_);
       });
    }
 
    public void func_70645_a(DamageSource p_70645_1_) {
+      if (net.minecraftforge.common.ForgeHooks.onLivingDeath(this, p_70645_1_)) return;
       boolean flag = this.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223609_l);
-      if (flag) {
-         ITextComponent itextcomponent = this.func_110142_aN().func_151521_b();
+
+      // CraftBukkit start - fire PlayerDeathEvent
+      if (this.field_70729_aU) {
+         return;
+      }
+      java.util.List<org.bukkit.inventory.ItemStack> loot = new java.util.ArrayList<org.bukkit.inventory.ItemStack>(this.field_71071_by.func_70302_i_());
+      boolean keepInventory = this.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223600_c) || this.func_175149_v();
+      if (!keepInventory) {
+         for (ItemStack item : this.field_71071_by.getContents()) {
+            if (!item.func_190926_b() && !EnchantmentHelper.func_190939_c(item)) {
+               loot.add(CraftItemStack.asCraftMirror(item));
+            }
+         }
+      }
+      // SPIGOT-5071: manually add player loot tables (SPIGOT-5195 - ignores keepInventory rule)
+      this.func_213354_a(p_70645_1_, this.field_110153_bc > 0);
+      for (org.bukkit.inventory.ItemStack item : this.drops) {
+         loot.add(item);
+      }
+      this.drops.clear(); // SPIGOT-5188: make sure to clear
+
+      ITextComponent defaultMessage = this.func_110142_aN().func_151521_b();
+      String deathmessage = defaultMessage.getString();
+      org.bukkit.event.entity.PlayerDeathEvent event = CraftEventFactory.callPlayerDeathEvent(this, loot, deathmessage, keepInventory);
+      // SPIGOT-943 - only call if they have an inventory open
+      if (this.field_71070_bA != this.field_71069_bz) {
+         this.func_71128_l();
+      }
+      String deathMessage = event.getDeathMessage();
+      if (deathMessage != null && deathMessage.length() > 0 && flag) { // TODO: allow plugins to override?
+         ITextComponent itextcomponent;
+         if (deathMessage.equals(deathmessage)) {
+            itextcomponent = this.func_110142_aN().func_151521_b();
+         } else {
+            itextcomponent = org.bukkit.craftbukkit.util.CraftChatMessage.fromStringOrNull(deathMessage);
+         }
          this.field_71135_a.func_211148_a(new SCombatPacket(this.func_110142_aN(), SCombatPacket.Event.ENTITY_DIED, itextcomponent), (p_212356_2_) -> {
             if (!p_212356_2_.isSuccess()) {
                int i = 256;
@@ -498,11 +674,17 @@
          this.func_241157_eT_();
       }
 
-      if (!this.func_175149_v()) {
-         this.func_213345_d(p_70645_1_);
+      // SPIGOT-5478 must be called manually now
+      this.func_226294_cV_();
+      // we clean the player's inventory after the EntityDeathEvent is called so plugins can get the exact state of the inventory.
+      if (!event.getKeepInventory()) {
+         this.field_71071_by.func_174888_l();
       }
 
-      this.func_96123_co().func_197893_a(ScoreCriteria.field_96642_c, this.func_195047_I_(), Score::func_96648_a);
+      this.func_175399_e(this); // Remove spectated target
+      // CraftBukkit end
+
+      // CraftBukkit - Get our scores instead
       LivingEntity livingentity = this.func_94060_bK();
       if (livingentity != null) {
          this.func_71029_a(Stats.field_199091_i.func_199076_b(livingentity.func_200600_R()));
@@ -534,10 +716,12 @@
          this.func_85039_t(p_191956_2_);
          String s = this.func_195047_I_();
          String s1 = p_191956_1_.func_195047_I_();
-         this.func_96123_co().func_197893_a(ScoreCriteria.field_96640_e, s, Score::func_96648_a);
+         // CraftBukkit - Get our scores instead
+         this.field_70170_p.getServerCB().getScoreboardManager().getScoreboardScores(ScoreCriteria.field_96640_e, s, Score::func_96648_a);
          if (p_191956_1_ instanceof PlayerEntity) {
             this.func_195066_a(Stats.field_75932_A);
-            this.func_96123_co().func_197893_a(ScoreCriteria.field_96639_d, s, Score::func_96648_a);
+            // CraftBukkit - Get our scores instead
+            this.field_70170_p.getServerCB().getScoreboardManager().getScoreboardScores(ScoreCriteria.field_96639_d, s, Score::func_96648_a);
          } else {
             this.func_195066_a(Stats.field_188070_B);
          }
@@ -592,17 +776,27 @@
    }
 
    private boolean func_175400_cq() {
-      return this.field_71133_b.func_71219_W();
+      // CraftBukkit - this.server.isPVPEnabled() -> this.world.pvpMode
+      return this.field_70170_p.pvpMode;
    }
 
    @Nullable
    public Entity func_241206_a_(ServerWorld p_241206_1_) {
-      this.field_184851_cj = true;
+      // CraftBukkit - start
+      return func_241206_a_(p_241206_1_, TeleportCause.UNKNOWN);
+   }
+
+   public Entity func_241206_a_(ServerWorld p_241206_1_, PlayerTeleportEvent.TeleportCause cause) {
+      // CraftBukkit end
+      if (this.func_70608_bn()) return this; // CraftBukkit - SPIGOT-3154
+      if (!net.minecraftforge.common.ForgeHooks.onTravelToDimension(this, p_241206_1_.func_234923_W_())) return null;
+      //this.invulnerableDimensionChange = true; // CraftBukkit - Moved down and into PlayerList#changeDimension
       ServerWorld serverworld = this.func_71121_q();
       RegistryKey<World> registrykey = serverworld.func_234923_W_();
       if (registrykey == World.field_234920_i_ && p_241206_1_.func_234923_W_() == World.field_234918_g_) {
+         this.field_184851_cj = true;
          this.func_213319_R();
-         this.func_71121_q().func_217434_e(this);
+         this.func_71121_q().removePlayer(this, true); //Forge: The player entity is cloned so keep the data until after cloning calls copyFrom
          if (!this.field_71136_j) {
             this.field_71136_j = true;
             this.field_71135_a.func_147359_a(new SChangeGameStatePacket(SChangeGameStatePacket.field_241768_e_, this.field_192040_cp ? 0.0F : 1.0F));
@@ -611,13 +805,18 @@
 
          return this;
       } else {
-         IWorldInfo iworldinfo = p_241206_1_.func_72912_H();
-         this.field_71135_a.func_147359_a(new SRespawnPacket(p_241206_1_.func_234922_V_(), p_241206_1_.func_234923_W_(), BiomeManager.func_235200_a_(p_241206_1_.func_72905_C()), this.field_71134_c.func_73081_b(), this.field_71134_c.func_241815_c_(), p_241206_1_.func_234925_Z_(), p_241206_1_.func_241109_A_(), true));
-         this.field_71135_a.func_147359_a(new SServerDifficultyPacket(iworldinfo.func_176130_y(), iworldinfo.func_176123_z()));
-         PlayerList playerlist = this.field_71133_b.func_184103_al();
-         playerlist.func_187243_f(this);
-         serverworld.func_217434_e(this);
-         this.field_70128_L = false;
+         // CraftBukkit start
+         /*
+         IWorldInfo iworldinfo = p_241206_1_.getWorldInfo();
+         this.connection.sendPacket(new SRespawnPacket(p_241206_1_.func_234922_V_(), p_241206_1_.func_234923_W_(), BiomeManager.func_235200_a_(p_241206_1_.getSeed()), this.interactionManager.getGameType(), this.interactionManager.func_241815_c_(), p_241206_1_.func_234925_Z_(), p_241206_1_.func_241109_A_(), true));
+         this.connection.sendPacket(new SServerDifficultyPacket(iworldinfo.getDifficulty(), iworldinfo.isDifficultyLocked()));
+         PlayerList playerlist = this.server.getPlayerList();
+         playerlist.updatePermissionLevel(this);
+         serverworld.removeEntity(this, true); //Forge: the player entity is moved to the new world, NOT cloned. So keep the data alive with no matching invalidate call.
+         this.revive();
+          */
+         // CraftBukkit end
+
          double d0 = this.func_226277_ct_();
          double d1 = this.func_226278_cu_();
          double d2 = this.func_226281_cx_();
@@ -649,7 +848,26 @@
             }
          }
 
-         this.func_70012_b(d0, d1, d2, f1, f);
+         // CraftBukkit start
+         Location enter = this.getBukkitEntity().getLocation();
+         Location exit = (serverworld == null) ? null : new Location(serverworld.getWorldCB(), d0, d1, d2, f1, f);
+         PlayerPortalEvent event = new PlayerPortalEvent(this.getBukkitEntity(), enter, exit, cause, 128, true, registrykey == World.field_234920_i_ ? 0 : 16);
+         Bukkit.getServer().getPluginManager().callEvent(event);
+         if (event.isCancelled() || event.getTo() == null) {
+            return null;
+         }
+         exit = event.getTo();
+         if (exit == null) {
+            return null;
+         }
+         serverworld = ((CraftWorld) exit.getWorld()).getHandle();
+         d0 = exit.getX();
+         d1 = exit.getY();
+         d2 = exit.getZ();
+         // CraftBukkit end
+
+         // this.setLocationAndAngles(d0, d1, d2, f1, f); // CraftBukkit - PlayerTeleportEvent handles position changes
+
          serverworld.func_217381_Z().func_76319_b();
          serverworld.func_217381_Z().func_76320_a("placing");
          double d6 = Math.min(-2.9999872E7D, p_241206_1_.func_175723_af().func_177726_b() + 16.0D);
@@ -658,24 +876,70 @@
          double d5 = Math.min(2.9999872E7D, p_241206_1_.func_175723_af().func_177733_e() - 16.0D);
          d0 = MathHelper.func_151237_a(d0, d6, d4);
          d2 = MathHelper.func_151237_a(d2, d7, d5);
-         this.func_70012_b(d0, d1, d2, f1, f);
+         // this.setLocationAndAngles(d0, d1, d2, f1, f);  // CraftBukkit - PlayerTeleportEvent handles position changes
+         // CraftBukkit start - PlayerPortalEvent implementation
+         Vector3d exitVelocity = Vector3d.field_186680_a;
+         BlockPos exitPosition = new BlockPos(d0, d1, d2);
          if (p_241206_1_.func_234923_W_() == World.field_234920_i_) {
-            int i = MathHelper.func_76128_c(this.func_226277_ct_());
-            int j = MathHelper.func_76128_c(this.func_226278_cu_()) - 1;
-            int k = MathHelper.func_76128_c(this.func_226281_cx_());
-            ServerWorld.func_241121_a_(p_241206_1_);
-            this.func_70012_b((double)i, (double)j, (double)k, f1, 0.0F);
-            this.func_213317_d(Vector3d.field_186680_a);
-         } else if (!p_241206_1_.func_85176_s().func_222268_a(this, f2)) {
-            p_241206_1_.func_85176_s().func_85188_a(this);
-            p_241206_1_.func_85176_s().func_222268_a(this, f2);
+            int i = exitPosition.func_177958_n();
+            int j = exitPosition.func_177956_o() - 1;
+            int k = exitPosition.func_177952_p();
+            if (event.getCanCreatePortal()) {
+               ServerWorld.func_241121_a_(serverworld, this);
+            }
+            // handled below for PlayerTeleportEvent
+            exit.setX(i);
+            exit.setY(j);
+            exit.setZ(k);
+            exitVelocity = Vector3d.field_186680_a;
+         } else {
+            PortalInfo portalShape = serverworld.func_85176_s().placeInPortal(this, exitPosition, f2, event.getSearchRadius(), true);
+            if (portalShape == null && event.getCanCreatePortal()) {
+               if (serverworld.func_85176_s().makePortal(this, exitPosition, event.getCreationRadius())) { // Only check for new portal if creation succeeded
+                  portalShape = serverworld.func_85176_s().placeInPortal(this, exitPosition, f2, event.getSearchRadius(), true);
+               }
+            }
+            // Check if portal was found
+            if (portalShape == null) {
+               return null;
+            }
+            // Teleport handling - logic from PortalTravelAgent#findAndTeleport
+            exitVelocity = portalShape.field_222506_b;
+            exit.setX(portalShape.field_222505_a.func_82615_a());
+            exit.setY(portalShape.field_222505_a.func_82617_b());
+            exit.setZ(portalShape.field_222505_a.func_82616_c());
+            exit.setYaw(f2 + (float) portalShape.field_222507_c);
+            // CraftBukkit end
          }
 
          serverworld.func_217381_Z().func_76319_b();
+
+         // CraftBukkit start - PlayerTeleportEvent
+         PlayerTeleportEvent tpEvent = new PlayerTeleportEvent(this.getBukkitEntity(), enter, exit, cause);
+         Bukkit.getServer().getPluginManager().callEvent(tpEvent);
+         if (tpEvent.isCancelled() || tpEvent.getTo() == null) {
+            return null;
+         }
+         exit = tpEvent.getTo();
+         if (exit == null) {
+            return null;
+         }
+         serverworld = ((CraftWorld) exit.getWorld()).getHandle();
+         this.field_184851_cj = true; // CraftBukkit - Set teleport invulnerability only if player changing worlds
+         this.field_71135_a.func_147359_a(new SRespawnPacket(serverworld.func_234922_V_(), serverworld.func_234923_W_(), BiomeManager.func_235200_a_(serverworld.func_72905_C()), this.field_71134_c.func_73081_b(), this.field_71134_c.func_241815_c_(), serverworld.func_234925_Z_(), serverworld.func_241109_A_(), true));
+         this.field_71135_a.func_147359_a(new SServerDifficultyPacket(this.field_70170_p.func_175659_aa(), this.field_70170_p.func_72912_H().func_176123_z()));
+         PlayerList playerlist = this.field_71133_b.func_184103_al();
+         playerlist.func_187243_f(this);
+         serverworld.func_217434_e(this);
+         this.field_70729_aU = false;
+         this.func_213317_d(exitVelocity);
+         // CraftBukkit end
+
          this.func_70029_a(p_241206_1_);
          p_241206_1_.func_217447_b(this);
          this.func_213846_b(serverworld);
-         this.field_71135_a.func_147364_a(this.func_226277_ct_(), this.func_226278_cu_(), this.func_226281_cx_(), f1, f);
+         this.field_71135_a.teleport(exit); // CraftBukkit - use internal teleport without event
+         this.field_71135_a.func_184342_d(); // CraftBukkit - sync position after changing it (from PortalTravelAgent#findAndteleport)
          this.field_71134_c.func_73080_a(p_241206_1_);
          this.field_71135_a.func_147359_a(new SPlayerAbilitiesPacket(this.field_71075_bZ));
          playerlist.func_72354_b(this, p_241206_1_);
@@ -689,6 +953,11 @@
          this.field_71144_ck = -1;
          this.field_71149_ch = -1.0F;
          this.field_71146_ci = -1;
+         // CraftBukkit start
+         PlayerChangedWorldEvent changeEvent = new PlayerChangedWorldEvent(this.getBukkitEntity(), serverworld.getWorldCB());
+         this.field_70170_p.getServerCB().getPluginManager().callEvent(changeEvent);
+         // CraftBukkit end
+         net.minecraftforge.fml.hooks.BasicEventHooks.firePlayerChangedDimensionEvent(this, registrykey, p_241206_1_.func_234923_W_());
          return this;
       }
    }
@@ -730,24 +999,27 @@
       this.field_71070_bA.func_75142_b();
    }
 
-   public Either<PlayerEntity.SleepResult, Unit> func_213819_a(BlockPos p_213819_1_) {
-      Direction direction = this.field_70170_p.func_180495_p(p_213819_1_).func_177229_b(HorizontalBlock.field_185512_D);
+   // CraftBukkit start - moved bed result checks from below into separate method
+   public Either<PlayerEntity.SleepResult, Unit> getBedResult(BlockPos at, Direction direction) {
+      Optional<BlockPos> optAt = Optional.of(at);
+      PlayerEntity.SleepResult ret = net.minecraftforge.event.ForgeEventFactory.onPlayerSleepInBed(this, optAt);
+      if (ret != null) return Either.left(ret);
       if (!this.func_70608_bn() && this.func_70089_S()) {
          if (!this.field_70170_p.func_230315_m_().func_236043_f_()) {
             return Either.left(PlayerEntity.SleepResult.NOT_POSSIBLE_HERE);
-         } else if (!this.func_241147_a_(p_213819_1_, direction)) {
+         } else if (!this.func_241147_a_(at, direction)) {
             return Either.left(PlayerEntity.SleepResult.TOO_FAR_AWAY);
-         } else if (this.func_241156_b_(p_213819_1_, direction)) {
+         } else if (this.func_241156_b_(at, direction)) {
             return Either.left(PlayerEntity.SleepResult.OBSTRUCTED);
          } else {
-            this.func_241153_a_(this.field_70170_p.func_234923_W_(), p_213819_1_, false, true);
+            this.func_241153_a_(this.field_70170_p.func_234923_W_(), at, false, true);
             if (this.field_70170_p.func_72935_r()) {
                return Either.left(PlayerEntity.SleepResult.NOT_POSSIBLE_NOW);
             } else {
                if (!this.func_184812_l_()) {
                   double d0 = 8.0D;
                   double d1 = 5.0D;
-                  Vector3d vector3d = Vector3d.func_237492_c_(p_213819_1_);
+                  Vector3d vector3d = Vector3d.func_237492_c_(at);
                   List<MonsterEntity> list = this.field_70170_p.func_175647_a(MonsterEntity.class, new AxisAlignedBB(vector3d.func_82615_a() - 8.0D, vector3d.func_82617_b() - 5.0D, vector3d.func_82616_c() - 8.0D, vector3d.func_82615_a() + 8.0D, vector3d.func_82617_b() + 5.0D, vector3d.func_82616_c() + 8.0D), (p_241146_1_) -> {
                      return p_241146_1_.func_230292_f_(this);
                   });
@@ -756,17 +1028,41 @@
                   }
                }
 
-               Either<PlayerEntity.SleepResult, Unit> either = super.func_213819_a(p_213819_1_).ifRight((p_241144_1_) -> {
+               return Either.right(Unit.INSTANCE);
+            }
+         }
+      } else {
+         return Either.left(PlayerEntity.SleepResult.OTHER_PROBLEM);
+      }
+   }
+
+   @Override
+   public Either<PlayerEntity.SleepResult, Unit> sleep(BlockPos blockposition, boolean force) {
+      Direction enumdirection = (Direction) this.field_70170_p.func_180495_p(blockposition).func_177229_b(HorizontalBlock.field_185512_D);
+      Either<PlayerEntity.SleepResult, Unit> bedResult = this.getBedResult(blockposition, enumdirection);
+      if (bedResult.left().orElse(null) == PlayerEntity.SleepResult.OTHER_PROBLEM) {
+         return bedResult; // return immediately if the result is not bypassable by plugins
+      }
+      if (force) {
+         bedResult = Either.right(Unit.INSTANCE);
+      }
+      bedResult = org.bukkit.craftbukkit.event.CraftEventFactory.callPlayerBedEnterEvent(this, blockposition, bedResult);
+      if (bedResult.left().isPresent()) {
+         return bedResult;
+      }
+      {
+         {
+            {
+               Either<PlayerEntity.SleepResult, Unit> either = super.sleep(blockposition, force).ifRight((unit) -> {
                   this.func_195066_a(Stats.field_188064_ad);
                   CriteriaTriggers.field_192136_p.func_192215_a(this);
                });
-               ((ServerWorld)this.field_70170_p).func_72854_c();
+               ((ServerWorld) this.field_70170_p).func_72854_c();
                return either;
             }
          }
-      } else {
-         return Either.left(PlayerEntity.SleepResult.OTHER_PROBLEM);
       }
+      // CraftBukkit end
    }
 
    public void func_213342_e(BlockPos p_213342_1_) {
@@ -775,6 +1071,7 @@
    }
 
    private boolean func_241147_a_(BlockPos p_241147_1_, Direction p_241147_2_) {
+      if (p_241147_2_ == null) return false;
       return this.func_241158_g_(p_241147_1_) || this.func_241158_g_(p_241147_1_.func_177972_a(p_241147_2_.func_176734_d()));
    }
 
@@ -789,6 +1086,7 @@
    }
 
    public void func_225652_a_(boolean p_225652_1_, boolean p_225652_2_) {
+      if (!this.func_70608_bn()) return; // CraftBukkit - Can't leave bed if not in one!
       if (this.func_70608_bn()) {
          this.func_71121_q().func_72863_F().func_217216_a(this, new SAnimateHandPacket(this, 2));
       }
@@ -854,6 +1152,13 @@
       this.field_71139_cq = this.field_71139_cq % 100 + 1;
    }
 
+   // CraftBukkit start
+   public int nextContainerCounter() {
+      this.field_71139_cq = this.field_71139_cq % 100 + 1;
+      return field_71139_cq;
+   }
+   // CraftBukkit end
+
    public OptionalInt func_213829_a(@Nullable INamedContainerProvider p_213829_1_) {
       if (p_213829_1_ == null) {
          return OptionalInt.empty();
@@ -864,6 +1169,23 @@
 
          this.func_71117_bO();
          Container container = p_213829_1_.createMenu(this.field_71139_cq, this.field_71071_by, this);
+         // CraftBukkit start - Inventory open hook
+         if (container != null) {
+            container.setTitle(p_213829_1_.func_145748_c_());
+            boolean cancelled = false;
+            container = CraftEventFactory.callInventoryOpenEvent(this, container, cancelled);
+            if (container == null && !cancelled) { // Let pre-cancelled events fall through
+               // SPIGOT-5263 - close chest if cancelled
+               if (p_213829_1_ instanceof IInventory) {
+                  ((IInventory) p_213829_1_).func_174886_c(this);
+               } else if (p_213829_1_ instanceof DoubleInventory) {
+                  // SPIGOT-5355 - double chests too :(
+                  ((DoubleInventory) p_213829_1_).inventorylargechest.func_174886_c(this);
+               }
+               return OptionalInt.empty();
+            }
+         }
+         // CraftBukkit end
          if (container == null) {
             if (this.func_175149_v()) {
                this.func_146105_b((new TranslationTextComponent("container.spectatorCantOpen")).func_240699_a_(TextFormatting.RED), true);
@@ -871,9 +1193,11 @@
 
             return OptionalInt.empty();
          } else {
-            this.field_71135_a.func_147359_a(new SOpenWindowPacket(container.field_75152_c, container.func_216957_a(), p_213829_1_.func_145748_c_()));
-            container.func_75132_a(this);
+            // CraftBukkit start
             this.field_71070_bA = container;
+            this.field_71135_a.func_147359_a(new SOpenWindowPacket(container.field_75152_c, container.func_216957_a(), container.getTitle()));
+            // CraftBukkit end
+            net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.player.PlayerContainerEvent.Open(this, this.field_71070_bA));
             return OptionalInt.of(this.field_71139_cq);
          }
       }
@@ -884,14 +1208,25 @@
    }
 
    public void func_184826_a(AbstractHorseEntity p_184826_1_, IInventory p_184826_2_) {
+      // CraftBukkit start - Inventory open hook
+      this.nextContainerCounter();
+      Container container = new HorseInventoryContainer(this.field_71139_cq, this.field_71071_by, p_184826_2_, p_184826_1_);
+      container.setTitle(p_184826_1_.func_145748_c_());
+      container = CraftEventFactory.callInventoryOpenEvent(this, container);
+      if (container == null) {
+         p_184826_2_.func_174886_c(this);
+         return;
+      }
+      // CraftBukkit end
       if (this.field_71070_bA != this.field_71069_bz) {
          this.func_71053_j();
       }
 
-      this.func_71117_bO();
+      // this.getNextWindowId(); // CraftBukkit - moved up
       this.field_71135_a.func_147359_a(new SOpenHorseWindowPacket(this.field_71139_cq, p_184826_2_.func_70302_i_(), p_184826_1_.func_145782_y()));
-      this.field_71070_bA = new HorseInventoryContainer(this.field_71139_cq, this.field_71071_by, p_184826_2_, p_184826_1_);
+      this.field_71070_bA = container; // CraftBukkit
       this.field_71070_bA.func_75132_a(this);
+      net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.player.PlayerContainerEvent.Open(this, this.field_71070_bA));
    }
 
    public void func_184814_a(ItemStack p_184814_1_, Hand p_184814_2_) {
@@ -930,6 +1265,11 @@
    public void func_71110_a(Container p_71110_1_, NonNullList<ItemStack> p_71110_2_) {
       this.field_71135_a.func_147359_a(new SWindowItemsPacket(p_71110_1_.field_75152_c, p_71110_2_));
       this.field_71135_a.func_147359_a(new SSetSlotPacket(-1, -1, this.field_71071_by.func_70445_o()));
+      // CraftBukkit start - Send a Set Slot to update the crafting result slot
+      if (java.util.EnumSet.of(InventoryType.CRAFTING, InventoryType.WORKBENCH).contains(field_71069_bz.getBukkitView().getType())) {
+         this.field_71135_a.func_147359_a(new SSetSlotPacket(field_71069_bz.field_75152_c, 0, field_71069_bz.func_75139_a(0).func_75211_c()));
+      }
+      // CraftBukkit end
    }
 
    public void func_71112_a(Container p_71112_1_, int p_71112_2_, int p_71112_3_) {
@@ -937,6 +1277,7 @@
    }
 
    public void func_71053_j() {
+      CraftEventFactory.handleInventoryCloseEvent(this); // CraftBukkit
       this.field_71135_a.func_147359_a(new SCloseWindowPacket(this.field_71070_bA.field_75152_c));
       this.func_71128_l();
    }
@@ -949,6 +1290,7 @@
 
    public void func_71128_l() {
       this.field_71070_bA.func_75134_a(this);
+      net.minecraftforge.common.MinecraftForge.EVENT_BUS.post(new net.minecraftforge.event.entity.player.PlayerContainerEvent.Close(this, this.field_71070_bA));
       this.field_71070_bA = this.field_71069_bz;
    }
 
@@ -970,14 +1312,14 @@
 
    public void func_71064_a(Stat<?> p_71064_1_, int p_71064_2_) {
       this.field_147103_bO.func_150871_b(this, p_71064_1_, p_71064_2_);
-      this.func_96123_co().func_197893_a(p_71064_1_, this.func_195047_I_(), (p_195396_1_) -> {
+      this.field_70170_p.getServerCB().getScoreboardManager().getScoreboardScores(p_71064_1_, this.func_195047_I_(), (p_195396_1_) -> {
          p_195396_1_.func_96649_a(p_71064_2_);
       });
    }
 
    public void func_175145_a(Stat<?> p_175145_1_) {
       this.field_147103_bO.func_150873_a(this, p_175145_1_, 0);
-      this.func_96123_co().func_197893_a(p_175145_1_, this.func_195047_I_(), Score::func_197891_c);
+      this.field_70170_p.getServerCB().getScoreboardManager().getScoreboardScores(p_175145_1_, this.func_195047_I_(), Score::func_197891_c);
    }
 
    public int func_195065_a(Collection<IRecipe<?>> p_195065_1_) {
@@ -1018,8 +1360,17 @@
 
    public void func_71118_n() {
       this.field_71149_ch = -1.0E8F;
+      this.field_71144_ck = -1; // CraftBukkit - Added to reset
    }
 
+   // CraftBukkit start - Support multi-line messages
+   public void sendMessage(ITextComponent[] ichatbasecomponent) {
+      for (ITextComponent component : ichatbasecomponent) {
+         this.func_145747_a(component, Util.field_240973_b_);
+      }
+   }
+   // CraftBukkit end
+
    public void func_146105_b(ITextComponent p_146105_1_, boolean p_146105_2_) {
       this.field_71135_a.func_147359_a(new SChatPacket(p_146105_1_, p_146105_2_ ? ChatType.GAME_INFO : ChatType.CHAT, Util.field_240973_b_));
    }
@@ -1069,12 +1420,20 @@
       this.field_71144_ck = -1;
       this.field_71149_ch = -1.0F;
       this.field_71146_ci = -1;
-      this.field_192041_cq.func_193824_a(p_193104_1_.field_192041_cq);
+      // this.recipeBook.copyFrom(that.recipeBook); // CraftBukkit
       this.field_71130_g.addAll(p_193104_1_.field_71130_g);
       this.field_192040_cp = p_193104_1_.field_192040_cp;
       this.field_193110_cw = p_193104_1_.field_193110_cw;
       this.func_192029_h(p_193104_1_.func_192023_dk());
       this.func_192031_i(p_193104_1_.func_192025_dl());
+      this.field_213329_S = false; // SPIGOT-4767
+
+      //Copy over a section of the Entity Data from the old player.
+      //Allows mods to specify data that persists after players respawn.
+      CompoundNBT old = p_193104_1_.getPersistentData();
+      if (old.func_74764_b(PERSISTED_NBT_TAG))
+          getPersistentData().func_218657_a(PERSISTED_NBT_TAG, old.func_74781_a(PERSISTED_NBT_TAG));
+      net.minecraftforge.event.ForgeEventFactory.onPlayerClone(this, p_193104_1_, !p_193104_2_);
    }
 
    protected void func_70670_a(EffectInstance p_70670_1_) {
@@ -1133,6 +1492,17 @@
    }
 
    public void func_71033_a(GameType p_71033_1_) {
+      // CraftBukkit start
+      if (p_71033_1_ == this.field_71134_c.func_73081_b()) {
+         return;
+      }
+      PlayerGameModeChangeEvent event = new PlayerGameModeChangeEvent(getBukkitEntity(), GameMode.getByValue(p_71033_1_.func_77148_a()));
+      field_70170_p.getServerCB().getPluginManager().callEvent(event);
+      if (event.isCancelled()) {
+         return;
+      }
+      // CraftBukkit end
+
       this.field_71134_c.func_73076_a(p_71033_1_);
       this.field_71135_a.func_147359_a(new SChangeGameStatePacket(SChangeGameStatePacket.field_241767_d_, (float)p_71033_1_.func_77148_a()));
       if (p_71033_1_ == GameType.SPECTATOR) {
@@ -1158,6 +1528,11 @@
       this.func_241151_a_(p_145747_1_, ChatType.SYSTEM, p_145747_2_);
    }
 
+   @Override
+   public CommandSender getBukkitSender(CommandSource p0) {
+      return null;
+   }
+
    public void func_241151_a_(ITextComponent p_241151_1_, ChatType p_241151_2_, UUID p_241151_3_) {
       this.field_71135_a.func_211148_a(new SChatPacket(p_241151_1_, p_241151_2_, p_241151_3_), (p_241149_4_) -> {
          if (!p_241149_4_.isSuccess() && (p_241151_2_ == ChatType.GAME_INFO || p_241151_2_ == ChatType.SYSTEM)) {
@@ -1176,7 +1551,19 @@
       return s.substring(0, s.indexOf(":"));
    }
 
+   public String locale = "en_us"; // CraftBukkit - add, lowercase
    public void func_147100_a(CClientSettingsPacket p_147100_1_) {
+      // CraftBukkit start
+      if (func_184591_cq() != p_147100_1_.func_186991_f()) {
+         PlayerChangedMainHandEvent event = new PlayerChangedMainHandEvent(getBukkitEntity(), func_184591_cq() == HandSide.LEFT ? MainHand.LEFT : MainHand.RIGHT);
+         this.field_71133_b.server.getPluginManager().callEvent(event);
+      }
+      if (!this.language.equals(p_147100_1_.field_149530_a)) {
+         PlayerLocaleChangeEvent event = new PlayerLocaleChangeEvent(getBukkitEntity(), p_147100_1_.field_149530_a);
+         this.field_71133_b.server.getPluginManager().callEvent(event);
+      }
+      this.clientViewDistance = p_147100_1_.field_149528_b;
+      // CraftBukkit end
       this.field_71143_cn = p_147100_1_.func_149523_e();
       this.field_71140_co = p_147100_1_.func_149520_f();
       this.func_184212_Q().func_187227_b(field_184827_bp, (byte)p_147100_1_.func_149521_d());
@@ -1239,7 +1626,7 @@
       this.field_175401_bS = (Entity)(p_175399_1_ == null ? this : p_175399_1_);
       if (entity != this.field_175401_bS) {
          this.field_71135_a.func_147359_a(new SCameraPacket(this.field_175401_bS));
-         this.func_70634_a(this.field_175401_bS.func_226277_ct_(), this.field_175401_bS.func_226278_cu_(), this.field_175401_bS.func_226281_cx_());
+         this.field_71135_a.setPlayerLocation(this.field_175401_bS.func_226277_ct_(), this.field_175401_bS.func_226278_cu_(), this.field_175401_bS.func_226281_cx_(), this.field_70177_z, this.field_70125_A, TeleportCause.SPECTATE); // CraftBukkit
       }
 
    }
@@ -1266,7 +1653,7 @@
 
    @Nullable
    public ITextComponent func_175396_E() {
-      return null;
+      return listName; // CraftBukkit
    }
 
    public void func_184609_a(Hand p_184609_1_) {
@@ -1286,29 +1673,39 @@
       return this.field_192042_bX;
    }
 
+   // CraftBukkit start
    public void func_200619_a(ServerWorld p_200619_1_, double p_200619_2_, double p_200619_4_, double p_200619_6_, float p_200619_8_, float p_200619_9_) {
+      this.teleport(p_200619_1_, p_200619_2_, p_200619_4_, p_200619_6_, p_200619_8_, p_200619_9_, org.bukkit.event.player.PlayerTeleportEvent.TeleportCause.UNKNOWN);
+   }
+
+   public void teleport(ServerWorld newWorld, double x, double y, double z, float yaw, float pitch, org.bukkit.event.player.PlayerTeleportEvent.TeleportCause cause) {
+      // CraftBukkit end
       this.func_175399_e(this);
       this.func_184210_p();
-      if (p_200619_1_ == this.field_70170_p) {
-         this.field_71135_a.func_147364_a(p_200619_2_, p_200619_4_, p_200619_6_, p_200619_8_, p_200619_9_);
-      } else {
-         ServerWorld serverworld = this.func_71121_q();
-         IWorldInfo iworldinfo = p_200619_1_.func_72912_H();
-         this.field_71135_a.func_147359_a(new SRespawnPacket(p_200619_1_.func_234922_V_(), p_200619_1_.func_234923_W_(), BiomeManager.func_235200_a_(p_200619_1_.func_72905_C()), this.field_71134_c.func_73081_b(), this.field_71134_c.func_241815_c_(), p_200619_1_.func_234925_Z_(), p_200619_1_.func_241109_A_(), true));
-         this.field_71135_a.func_147359_a(new SServerDifficultyPacket(iworldinfo.func_176130_y(), iworldinfo.func_176123_z()));
-         this.field_71133_b.func_184103_al().func_187243_f(this);
-         serverworld.func_217434_e(this);
-         this.field_70128_L = false;
-         this.func_70012_b(p_200619_2_, p_200619_4_, p_200619_6_, p_200619_8_, p_200619_9_);
-         this.func_70029_a(p_200619_1_);
-         p_200619_1_.func_217446_a(this);
+       /* CraftBukkit start - replace with bukkit handling for multi-world
+      if (newWorld == this.world) {
+         this.connection.setPlayerLocation(x, y, z, yaw, pitch);
+      } else if (net.minecraftforge.common.ForgeHooks.onTravelToDimension(this, newWorld.func_234923_W_())) {
+         ServerWorld serverworld = this.getServerWorld();
+         IWorldInfo iworldinfo = newWorld.getWorldInfo();
+         this.connection.sendPacket(new SRespawnPacket(newWorld.func_234922_V_(), newWorld.func_234923_W_(), BiomeManager.func_235200_a_(newWorld.getSeed()), this.interactionManager.getGameType(), this.interactionManager.func_241815_c_(), newWorld.func_234925_Z_(), newWorld.func_241109_A_(), true));
+         this.connection.sendPacket(new SServerDifficultyPacket(iworldinfo.getDifficulty(), iworldinfo.isDifficultyLocked()));
+         this.server.getPlayerList().updatePermissionLevel(this);
+         serverworld.removePlayer(this, true); //Forge: The player entity itself is moved, and not cloned. So we need to keep the data alive with no matching invalidate call later.
+         this.revive();
+         this.setLocationAndAngles(x, y, z, yaw, pitch);
+         this.setWorld(newWorld);
+         newWorld.addDuringCommandTeleport(this);
          this.func_213846_b(serverworld);
-         this.field_71135_a.func_147364_a(p_200619_2_, p_200619_4_, p_200619_6_, p_200619_8_, p_200619_9_);
-         this.field_71134_c.func_73080_a(p_200619_1_);
-         this.field_71133_b.func_184103_al().func_72354_b(this, p_200619_1_);
-         this.field_71133_b.func_184103_al().func_72385_f(this);
+         this.connection.setPlayerLocation(x, y, z, yaw, pitch);
+         this.interactionManager.setWorld(newWorld);
+         this.server.getPlayerList().sendWorldInfo(this, newWorld);
+         this.server.getPlayerList().sendInventory(this);
+         net.minecraftforge.fml.hooks.BasicEventHooks.firePlayerChangedDimensionEvent(this, serverworld.func_234923_W_(), newWorld.func_234923_W_());
       }
-
+      */
+      this.getBukkitEntity().teleport(new Location(newWorld.getWorldCB(), x, y, z, yaw, pitch), cause);
+      // CraftBukkit end
    }
 
    @Nullable
@@ -1375,6 +1772,8 @@
       if (itementity == null) {
          return null;
       } else {
+         if (captureDrops() != null) captureDrops().add(itementity);
+         else
          this.field_70170_p.func_217376_c(itementity);
          ItemStack itemstack = itementity.func_92059_d();
          if (p_146097_3_) {
@@ -1388,4 +1787,123 @@
          return itementity;
       }
    }
+
+   // CraftBukkit start - Add per-player time and weather.
+   public long timeOffset = 0;
+   public boolean relativeTime = true;
+   public long getPlayerTime() {
+      if (this.relativeTime) {
+         // Adds timeOffset to the current server time.
+         return this.field_70170_p.func_72820_D() + this.timeOffset;
+      } else {
+         // Adds timeOffset to the beginning of this day.
+         return this.field_70170_p.func_72820_D() - (this.field_70170_p.func_72820_D() % 24000) + this.timeOffset;
+      }
+   }
+   public WeatherType weather = null;
+   public WeatherType getPlayerWeather() {
+      return this.weather;
+   }
+   public void setPlayerWeather(WeatherType type, boolean plugin) {
+      if (!plugin && this.weather != null) {
+         return;
+      }
+      if (plugin) {
+         this.weather = type;
+      }
+      if (type == WeatherType.DOWNFALL) {
+         this.field_71135_a.func_147359_a(new SChangeGameStatePacket(SChangeGameStatePacket.field_241765_b_, 0));
+      } else {
+         this.field_71135_a.func_147359_a(new SChangeGameStatePacket(SChangeGameStatePacket.field_241766_c_, 0));
+      }
+   }
+   private float pluginRainPosition;
+   private float pluginRainPositionPrevious;
+   public void updateWeather(float oldRain, float newRain, float oldThunder, float newThunder) {
+      if (this.weather == null) {
+         // Vanilla
+         if (oldRain != newRain) {
+            this.field_71135_a.func_147359_a(new SChangeGameStatePacket(SChangeGameStatePacket.field_241771_h_, newRain));
+         }
+      } else {
+         // Plugin
+         if (pluginRainPositionPrevious != pluginRainPosition) {
+            this.field_71135_a.func_147359_a(new SChangeGameStatePacket(SChangeGameStatePacket.field_241771_h_, pluginRainPosition));
+         }
+      }
+      if (oldThunder != newThunder) {
+         if (weather == WeatherType.DOWNFALL || weather == null) {
+            this.field_71135_a.func_147359_a(new SChangeGameStatePacket(SChangeGameStatePacket.field_241772_i_, newThunder));
+         } else {
+            this.field_71135_a.func_147359_a(new SChangeGameStatePacket(SChangeGameStatePacket.field_241772_i_, 0));
+         }
+      }
+   }
+   public void tickWeather() {
+      if (this.weather == null) return;
+      pluginRainPositionPrevious = pluginRainPosition;
+      if (weather == WeatherType.DOWNFALL) {
+         pluginRainPosition += 0.01;
+      } else {
+         pluginRainPosition -= 0.01;
+      }
+      pluginRainPosition = MathHelper.func_76131_a(pluginRainPosition, 0.0F, 1.0F);
+   }
+   public void resetPlayerWeather() {
+      this.weather = null;
+      this.setPlayerWeather(this.field_70170_p.func_72912_H().func_76059_o() ? WeatherType.DOWNFALL : WeatherType.CLEAR, false);
+   }
+   @Override
+   public String toString() {
+      return super.toString() + "(" + this.func_200200_C_() + " at " + this.func_226277_ct_() + "," + this.func_226278_cu_() + "," + this.func_226281_cx_() + ")";
+   }
+   // SPIGOT-1903, MC-98153
+   public void forceSetPositionRotation(double x, double y, double z, float yaw, float pitch) {
+      this.func_70012_b(x, y, z, yaw, pitch);
+      this.field_71135_a.func_184342_d();
+   }
+   @Override
+   protected boolean func_70610_aX() {
+      return super.func_70610_aX() || !getBukkitEntity().isOnline();
+   }
+   @Override
+   public Scoreboard func_96123_co() {
+      return getBukkitEntity().getScoreboard().getHandle();
+   }
+   public void reset() {
+      float exp = 0;
+      boolean keepInventory = this.field_70170_p.func_82736_K().func_223586_b(GameRules.field_223600_c);
+      if (this.keepLevel || keepInventory) {
+         exp = this.field_71106_cc;
+         this.newTotalExp = this.field_71067_cb;
+         this.newLevel = this.field_71068_ca;
+      }
+      this.func_70606_j(this.func_110138_aP());
+      this.field_190534_ay = 0;
+      this.field_70143_R = 0;
+      this.field_71100_bB = new FoodStats(this);
+      this.field_71068_ca = this.newLevel;
+      this.field_71067_cb = this.newTotalExp;
+      this.field_71106_cc = 0;
+      this.field_70725_aQ = 0;
+      this.func_85034_r(0);
+      this.clearActivePotions(org.bukkit.event.entity.EntityPotionEffectEvent.Cause.DEATH);
+      this.field_70752_e = true;
+      this.field_71070_bA = this.field_71069_bz;
+      this.field_70717_bb = null;
+      this.field_70755_b = null;
+      this.field_94063_bt = new CombatTracker(this);
+      this.field_71144_ck = -1;
+      if (this.keepLevel || keepInventory) {
+         this.field_71106_cc = exp;
+      } else {
+         this.func_82242_a(this.newExp);
+      }
+      this.keepLevel = false;
+   }
+   @Override
+   public CraftPlayer getBukkitEntity() {
+      return (CraftPlayer) super.getBukkitEntity();
+   }
+   // CraftBukkit end
 }
